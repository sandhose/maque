#!/bin/sh

# Default options
OPTS_MAKEFILE="`find . -name [Mm]akefile -maxdepth 1`"
OPTS_DRYRUN=false
OPTS_KEEPGOING=false
OPTS_TARGETS=""

# Show usage
usage () {
    cat <<EOL
Usage: `basename $0` [-f makefile] [-hkn] [target]
Options:
    -f FILE       Read FILE as a makefile
    -h            Print this message and exit.
    -k            Keep going when some targets can't be made.
    -n            Don't actually run any commands; just print them
EOL
}

# Create tempdir
init_tmpdir () {
    # Uses TMPDIR (fallback: /tmp)
    # ex: /tmp/maque-1234
    TDIR=${TMPDIR:-/tmp/}$(basename $0)-$$
    mkdir -p $TDIR
    trap "rm -r $TDIR" EXIT
}

# Parse commandline options
parse_commandline () {
    args=`getopt "f:hkn" $*`

    if [ $? != 0 ]; then
        usage >&2
        exit 2
    fi

    set -- $args
    for i; do
        case "$i" in
            -h) usage
                exit 0
                shift;;
            -f) OPTS_MAKEFILE=$2
                shift 2;;
            -k) OPTS_KEEPGOING=true
                shift;;
            -n) OPTS_DRYRUN=true
                shift;;
            --) shift
                break;;
        esac
    done

    # Testing makefile existence
    if [ ! -f $OPTS_MAKEFILE ] || [ -z $OPTS_MAKEFILE ]; then
        echo "$(basename $0): *** Makefile not found.  Stop." >&2
        exit 2
    fi
}

# Parse makefile
parse_makefile () {
    CURRENT_TARGET=""
    DEFAULT_TARGET=""
    LINE_NB=0

    # Keep leading spaces/tabs in `read`
    OLDIFS=$IFS
    IFS=''

    while read RAW_LINE; do
        LINE=`echo $RAW_LINE | sed -e 's/#.*$//g' -e 's/[[:space:]]*$//'`
        LINE_NB=$((LINE_NB + 1))
        if [ -z $LINE ]; then
            # Empty line, do nothing
            continue
        elif [ ! -z $CURRENT_TARGET ] && (echo "$LINE" | grep -q ^'\t'); then
            # Append commands to $CURRENT_TARGET commands file
            echo "$LINE" | sed 's/^[[:space:]]*\(.*\)$/\1/' >> $TDIR/$CURRENT_TARGET/commands
        elif (echo "$LINE" | grep -q '^.\+:\( .\+\)*$'); then
            # Change $CURRENT_TARGET and add dependencies in file
            CURRENT_TARGET=`echo $LINE | cut -d ':' -f 1`
            mkdir $TDIR/$CURRENT_TARGET
            touch $TDIR/$CURRENT_TARGET/commands
            echo "$LINE" | sed 's/^.*: *//g' > $TDIR/$CURRENT_TARGET/dependencies

            if [ -z $DEFAULT_TARGET ]; then
                DEFAULT_TARGET=$CURRENT_TARGET
            fi
        else
            echo "$1:$LINE_NB: *** Error parsing makefile.  Stop." >&2
            exit 2
        fi
    done < $1

    # Restore IFS
    IFS=$OLDIFS
}

# Run everything
init_tmpdir
parse_commandline $*
parse_makefile "$OPTS_MAKEFILE"

# vim: ts=4:sw=4:et
